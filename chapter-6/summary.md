# 6章 変数

- CommonLisp は以下のに種類の変数をサポートしている
  - レキシカル変数(lexical variable)；大雑把に言うとローカル変数
  - ダイナミック変数(dynamic variable)；大雑把に言うとグローバル変数
    - スペシャル変数(special variable)とも呼ばれることもある
    - 処理系によって使う単語が違う

## 6.1 変数の基礎

- 変数；値を保持できる名前付きの場所
  - CommonLispは動的型付け(dynamically typed)
    - 型付けがされていないため型宣言の必要はない
    - 型情報は値が持っている
    - 型エラーは動的に検出される
- すべての値はオブジェクトへの参照
  - 概念的には(？)
  - 値の変更でオブジェクトを変更しない
    - 変数がどのオブジェクトを指すのかがが変わるだけ
    - ただし、変更可能(mutable)なオブジェクトの参照なら変更できる
- 束縛
  - 束縛(binding)；変数の実行時における発現
    - 変数と紐付いたオブジェクトのことを束縛って呼んでるっぽい
  - 関数が呼ばれるたびに引数を保持するため新しい束縛(binding)を作る
  - ある一つの変数はたくさんの束縛を持てる
    - 例えば再帰関数は呼び出しのたびに束縛し直される
- 関数のパラメータが保持するのは参照
  - 参照の値渡し；Java、Pythonと似ている
- `LET`;新しい変数を導入する特殊フォーム
```
(let (valiable*)
  (body-form*))
```
  - `LET`フォームは新しい変数束縛を作る
  - 初期値フォームの評価後、適切な束縛が作られ `body-form`が実行される 
  - `LET` 本体の最後の式が返り値となる
  - `LET`を抜ければ参照はもとに戻る
- `LET*`
  - `LET`では 本体内でしか変数を使用できない
  - `LET*` は初期値のフォームで前に出てきた変数を使用できる
```
(let* ((x 10)
      (y (+ x 10)))
  (list x y))

# 以下と同じ
(let ((x 10))
  (let ((y (+ x 10)))
    (list x y)))
``` 
- 束縛フォームとして働く特別な構文要素
  - `DOTTIMES`;7章で解説
```
(dottimes (x 10) (format t "~d " x)) -> 0 1 2 3 4 5 6 7 8 9 
```

## 6.2 レキシカル変数とクロージャ

- クロージャ(closure:閉包)
  - 束縛フォームが導入する変数はレキシカルスコープを持つ
  - ローカル変数と似ているが、LETフォームによって作られた束縛を閉じ込めることができる
  - 無名関数が変数束縛を補足することもできる
```
(defparameter *fn*
  (let ((count 0))
    #'(lambda () (setf count (+1 count)))))

CL-USER> (funcall *fn*)
1
CL-USER> (funcall *fn*)
2
CL-USER> (funcall *fn*)
3
CL-USER> (funcall *fn*)
4
```
  - このような無名関数はクロージャ(closure:閉包)と呼ばれる
- 複数のクロージャから一つの変数束縛を補足することもできる
- 一つのクロージャに複数の変数束縛を持つこともできる

```
(let ((count 0))
  (list
    #'(lambda () (incf count))
    #'(lambda () (decf count))
    #'(lambda () (count count))))
```

## 6.3 ダイナミック変数。またの名をスペシャル変数

- ダイナミック変数
  - グローバル変数に近いもの
  - ダイナミック変数は `*変数名*` で表す
  - 使いすぎるとコードをわかりにくいものにするが便利なもの
  - ほかの言語にも存在している
    - Java; public staticフィールド
    - C; extern変数
    - python; モジュールレベル変数
    - Perl; パッケージレベル変数 
- ダイナミック変数の作り方は２種類ある
  - `DEFVAR`
    - 初期値を指定しないこともできる；未束縛(unbound)
    - 変数が未定義だった場合のみ初期値を代入する
    - ソースコードを変更しても維持しておきたいものに使用する
  - `DEFPARAMETER`
    - 評価されるたびに初期値を代入する
    - 定数的なものに使う？
```
(defvar *count* 0
  "製造済みの部品数")

(defparameter *get-tolerance* 0.001
  "部品間の隙間の許容幅")
```

- ダイナミック変数の利点
  - 変数を引数で持ち回る必要がない
  - 殆どの言語では標準入力、標準出力はグローバル変数に保存されている
  - 一時的に変更したい場合は代入すれば良い
  - もとに戻し忘れたら・・・・
  - Lispでは`LET`を使用してもとに戻し忘れることを防ぐことができる
```
(let ((*standerd-output* *some-ohter-output*))
  (stuff))
```

- 束縛を参照し得る期間；エクステント(extent)
- スコープは場所を示し、エクステントは時間を示す
- レキシカル変数はレキシカルなスコープを持つがエクステントは無限
- ダイナミック変数はスコープは無限でエクステントはダイナミック(束縛フォームを実行している間のみ)
- スペシャル変数と呼ばれるわけ
  - `DEFVAR` `DEFPARAMETER` で宣言された変数の名前はスペシャル(special)だと宣言される
  - 束縛フォームでスペシャル宣言を使用すると新たな束縛が作られる

